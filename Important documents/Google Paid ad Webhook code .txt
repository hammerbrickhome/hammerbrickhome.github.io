/**
 * split_data_on_open.js (FINAL PERMANENT FIX)
 *
 * This Google Apps Script (GAS) is designed to reliably receive and record
 * Google Ads leads using the webhook structure, ensuring custom fields
 * (like 'Work Type') are correctly mapped despite Google's internal naming
 * sanitization.
 *
 * FIX APPLIED: The mapLeadData function now cleans all symbols from
 * the column_id (e.g., 'what_type_of_work_do_you_need_done?') so the script
 * uses a stable key ('WHAT_TYPE_OF_WORK_DO_YOU_NEED_DONE_') which eliminates
 * header shifting and data loss.
 *
 * Sheet Name to Use: 'Google Leads'
 */

// Define the name of the sheet the script will write to.
const SHEET_NAME = 'Google Leads';

// Define the required column headers and their exact order.
const HEADERS = [
  'Timestamp',
  'Full Name',
  'Email',
  'Phone Number',
  'Campaign ID',
  'Ad Group ID',
  'Work Type', // Custom field location
  'Lead Source'
];

// Define the permanent, clean key for your custom field.
const CUSTOM_WORK_TYPE_KEY = 'WHAT_TYPE_OF_WORK_DO_YOU_NEED_DONE_';

/**
 * PRIVATE helper function to ensure the correct sheet and headers exist.
 * This function is now more aggressive and will force a header rewrite
 * if the sheet headers do not match the expected list precisely.
 */
function _setupHeaders() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(SHEET_NAME);

  if (!sheet) {
    // Create the sheet if it doesn't exist.
    sheet = ss.insertSheet(SHEET_NAME);
    Logger.log(`Created new sheet: ${SHEET_NAME}`);
  }

  // Get the range covering exactly the number of required headers.
  const headerRange = sheet.getRange(1, 1, 1, HEADERS.length);
  const existingHeaders = headerRange.getValues()[0];

  // Check if the existing headers are NOT identical to the required headers.
  // This check is now more explicit and compares the entire array string representation.
  if (existingHeaders.join('|') !== HEADERS.join('|')) {
    // FORCE the headers to be written exactly as defined.
    headerRange.setValues([HEADERS]);
    headerRange.setFontWeight('bold').setBackground('#E0E0E0');
    // Autosize columns for better visibility.
    sheet.autoResizeColumns(1, HEADERS.length);
    Logger.log('Headers written successfully (Forced Rewrite).');
  }
}

/**
 * Helper function to map the complex nested user_column_data array.
 * It sanitizes the column_id to create stable, predictable keys.
 */
function mapLeadData(data) {
  let mapped = {};

  if (data.user_column_data && Array.isArray(data.user_column_data)) {
    data.user_column_data.forEach(item => {
      if (item.column_id) {
        // Sanitize the column_id by replacing all non-word characters with underscore and capitalizing.
        // This ensures 'what_type_of_work_do_you_need_done?' becomes a stable key.
        let cleanId = item.column_id.replace(/\W+/g, "_").toUpperCase();
        mapped[cleanId] = item.string_value || item.int_value || '';
      }
    });
  }

  mapped.CAMPAIGN_ID = data.campaign_id;
  mapped.ADGROUP_ID = data.adgroup_id;

  return mapped;
}

/**
 * Required function to handle incoming POST requests (the webhook data).
 */
function doPost(e) {
  // Ensure headers are in place before writing data.
  _setupHeaders(); 

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME);
  
  let leadData = {};

  try {
    if (e.postData && e.postData.contents) {
      leadData = JSON.parse(e.postData.contents);
    } else {
      Logger.log("Error: Webhook received, but no JSON postData found.");
      return ContentService.createTextOutput("Error: No data received.");
    }
    
    const mappedData = mapLeadData(leadData);

    let newRow = [];

    // Data in the exact order of the 8 HEADERS
    newRow.push(new Date());                                                      // 1. Timestamp
    newRow.push(mappedData.FULL_NAME || '');                                      // 2. Full Name
    newRow.push(mappedData.EMAIL || '');                                          // 3. Email
    newRow.push(mappedData.PHONE_NUMBER || '');                                   // 4. Phone Number
    newRow.push(mappedData.CAMPAIGN_ID || '');                                    // 5. Campaign ID
    newRow.push(mappedData.ADGROUP_ID || '');                                     // 6. Ad Group ID
    newRow.push(mappedData[CUSTOM_WORK_TYPE_KEY] || '');                          // 7. Work Type (Now using the stable key)
    newRow.push(leadData.lead_source || 'Google Ads Webhook');                    // 8. Lead Source

    sheet.appendRow(newRow);
    
    Logger.log('New lead successfully recorded.');
    
    return ContentService.createTextOutput('Success: Lead recorded.');

  } catch (error) {
    Logger.log('Processing Error: ' + error.toString());
    return ContentService.createTextOutput('Error: ' + error.toString());
  }
}